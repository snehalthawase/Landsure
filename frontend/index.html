<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LandSure - Certificate Upload</title>
</head>
<body>
    <h2>Upload Land Certificate</h2>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="image" required />
        <button type="submit">Upload & Verify</button>
    </form>

    <div id="extractedData"></div>
    <button id="verifyBtn" style="display:none;">Submit for Verification</button>
    <div id="verificationResult"></div>

    <div id="bkForm" style="display:none;">
        <h3>Finalize Blockchain Storage</h3>
        <label>Total Area: <input type="text" id="totalArea" required></label><br>
        <label>Number of Tokens: <input type="number" id="numTokens" required></label><br>
        <button id="bkSubmitBtn">Submit to Blockchain</button>
    </div>
    <div id="bkResult"></div>

    <div id="dbForm" style="display:none;">
        <h3>Store Certificate in Database</h3>
        <label>Certificate Image URL: <input type="text" id="imageUrl" required></label><br>
        <label>Main Owner: <input type="text" id="mainOwner"></label><br>
        <button id="dbSubmitBtn">Submit to Database</button>
    </div>
    <div id="dbResult"></div>

    <script>
        let extractedData = null;
        let lastImageFile = null;

        const form = document.getElementById('uploadForm');
        const resultDiv = document.getElementById('extractedData');
        const verifyBtn = document.getElementById('verifyBtn');
        const verifyResult = document.getElementById('verificationResult');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const res = await fetch('http://localhost:5001/ocr', {
                method: 'POST',
                body: formData
            });
            extractedData = await res.json();
            
            // Store the file to use its name later
            const fileInput = document.querySelector('input[type="file"]');
            lastImageFile = fileInput.files[0];

            resultDiv.innerHTML = `<pre>${JSON.stringify(extractedData, null, 2)}</pre>`;
            verifyBtn.style.display = 'block';
        });

        verifyBtn.addEventListener('click', async () => {
            const res = await fetch('http://localhost:3000/certificates/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(extractedData)
            });
            const data = await res.json();

            if (data.verified) {
                verifyResult.innerHTML = `<span style="color: green;">✅ Verified Certificate</span><pre>${JSON.stringify(data.data, null, 2)}</pre>`;
                document.getElementById('bkForm').style.display = 'block'; // show blockchain form
            } else {
                verifyResult.innerHTML = `<span style="color: red;">❌ Fraudulent or Tampered Document</span>`;
            }
        });

        document.getElementById('bkSubmitBtn').addEventListener('click', async () => {
            let areaInput = document.getElementById('totalArea').value;
            let numericArea = 0;

            if (areaInput.toLowerCase().includes('acre')) {
                let acres = parseFloat(areaInput);
                numericArea = Math.round(acres * 4046.86);
            } else {
                numericArea = parseInt(areaInput);
            }

            const payload = {
                certificateId: extractedData.certificate_id,
                totalArea: document.getElementById('totalArea').value,
                numberOfTokens: Number(document.getElementById('numTokens').value),
                metadata: extractedData
            };

            const res = await fetch('http://localhost:3000/certificates/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            document.getElementById('bkResult').innerHTML = result.success
                ? `<span style="color: green;">✅ Stored on Blockchain</span><br>Tx Hash: ${result.transactionHash}`
                : `<span style="color: red;">❌ Failed: ${result.error}</span>`;

            // If blockchain storage is successful, show the DB form
            if (result.success) {
                document.getElementById('dbForm').style.display = 'block';
            }
        });

        // ⭐ NEW: Event listener for the "Submit to Database" button
        document.getElementById('dbSubmitBtn').addEventListener('click', async () => {
            const imageUrl = document.getElementById('imageUrl').value;
            const mainOwner = document.getElementById('mainOwner').value;

            if (!imageUrl) {
                document.getElementById('dbResult').innerHTML = `<span style="color: red;">❌ Please provide a Certificate Image URL.</span>`;
                return;
            }

            // Combine all relevant data into a single payload
            const payload = {
                ...extractedData, // Include the previously extracted OCR data
                imageUrl,
                mainOwner
            };

            try {
                const res = await fetch('http://localhost:3000/certificates/store-db', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();

                if (result.success) {
                    document.getElementById('dbResult').innerHTML = `<span style="color: green;">✅ Certificate data successfully stored in MongoDB!</span>`;
                } else {
                    document.getElementById('dbResult').innerHTML = `<span style="color: red;">❌ Failed to store in database: ${result.error}</span>`;
                }
            } catch (err) {
                document.getElementById('dbResult').innerHTML = `<span style="color: red;">❌ An error occurred during database submission.</span>`;
            }
        });
    </script>
</body>
</html>